<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Batucada Sequencer</title>
<link rel="stylesheet" href="style.css"/>
<link rel="manifest" href="app/app.webmanifest"/>
<link rel="icon" type="image/svg+xml" href="favicon.svg"/>
</head>
<body>
	<div id="sequencer">
		<a id="skip" href="#controls">Accéder aux boutons de contrôle</a>
		<h1 id="title"></h1>
		<table>
			<tr class="track" data-bars="[4,4]" data-beat="4" data-instrument="0" data-loop="1">
				<th scope="row">
					<div class="dropzone"></div>
					<div class="select" draggable="true">
						<div class="handle" title="Déplacer"></div>
						<button name="trackbutton" class="trackbutton" title="Modifier la piste">Instrument…</button>
					</div>
				</th>
				<td>
					<div class="sheet">
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
						<span class="bar"><button name="step" class="step" aria-label="note" value="0"></button><span class="sub_bar"><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button><button name="step" class="step" aria-label="note" value="0"></button></span></span>
					</div>
				</td>
				<td><label><input name="volume" class="volume" aria-label="volume" list="volume" title="Volume" type="range" value="30" min="0" max="60" autocomplete="off"></label></td>
			</tr>
		</table>
		<datalist id="volume">
			<option value="30"></option>
		</datalist>
		<hr>
		<div id="controls" role="toolbar" tabindex="-1">
			<div id="combo_presets" role="group">
				<button title="Gérer le morceau">Gérer le morceau</button>
				<select aria-label="morceaux">
					<option disabled hidden selected>Morceau</option>
					<option disabled>Aucun morceau</option>
				</select>
			</div>
			<label id="combo_tempo" for="tempo" title="Tempo">
				<input id="tempo" aria-label="tempo" type="range" value="80" min="60" max="160" step="4" autocomplete="off">
				<output for="tempo"><span>80</span> bpm</output>
			</label>
			<button id="reset">Effacer</button>
			<button id="start" role="switch" aria-checked="false" title="Démarrer / Arrêter">
				<div id="play">Démarrer</div>
				<div id="pause">Arrêter</div>
			</button>
		</div>
		<button id="aboutButton">À propos…</button>
		<dialog id="track">
			<form method="dialog">
				<h2>Modifier la piste</h2>
				<div>
					<label>Instrument
						<select id="instrument" name="instrument" autocomplete="off">
							<option value="0" disabled hidden selected>Choisir…</option>
						</select>
					</label>
					<label>Type de phrase
						<select id="loop" name="loop" autocomplete="off">
							<option value="0">𝟙 Introduction</option>
							<option value="1" selected>Tourne</option>
						</select>
					</label>
					<label>Nombre de temps
						<select id="bars" name="bars" autocomplete="off">
							<option value="[4,4]" selected>4</option>
							<option value="[6,6]">6</option>
							<option value="[8,4]">8</option>
							<option value="[12,4]">12 (3 × 4)</option>
							<option value="[12,6]">12 (2 × 6)</option>
							<option value="[16,4]">16</option>
							<option value="[24,4]">24 (6 × 4)</option>
							<option value="[24,6]">24 (4 × 6)</option>
							<option value="[32,4]">32</option>
						</select>
					</label>
					<label>Division du temps
						<select id="beat" name="beat" autocomplete="off">
							<option value="3">3</option>
							<option value="4" selected>4</option>
							<option value="6">6</option>
							<option value="8">8</option>
						</select>
					</label>
				</div>
				<div class="bottom">
					<button>Annuler</button><button name="apply">Appliquer</button>
				</div>
				<input type="hidden" id="trackindex">
			</form>
		</dialog>
		<dialog id="settings">
			<div>
				<h2>Gérer le morceau</h2>
				<form id="modify" method="dialog" hidden
					data-success="Le morceau a été enregistré."
					data-failure="⚠️ La modification a échoué."
					data-cancel-success="La modification a été annulée."
					data-cancel-failure="⚠️ La modification ne peut être annulée.">
					<fieldset>
						<legend>Enregistrer le morceau</legend>
						<input name="name" aria-label="nom du morceau" disabled>
						<button name="save">Enregistrer</button>
					</fieldset>
				</form>
				<form id="newOne" method="dialog"
					data-success="Le morceau a été enregistré."
					data-failure="⚠️ La modification a échoué."
					data-cancel-success="La modification a été annulée."
					data-cancel-failure="⚠️ La modification ne peut être annulée.">
					<fieldset>
						<legend>Enregistrer sous</legend>
						<input name="name" aria-label="nom du morceau" placeholder="Nom du morceau" autocomplete="off" required>
						<button name="save">Enregistrer</button>
					</fieldset>
				</form>
				<form id="rename" method="dialog" hidden
					data-success="Le morceau a été renommé."
					data-failure="⚠️ La modification a échoué."
					data-cancel-success="La modification a été annulée."
					data-cancel-failure="⚠️ La modification ne peut être annulée.">
					<fieldset>
						<legend>Renommer le morceau</legend>
						<input name="name" aria-label="nom du morceau" placeholder="Nom du morceau" autocomplete="off" required>
						<button name="save">Renommer</button>
					</fieldset>
				</form>
				<form id="delete" method="dialog" hidden
					data-success="Le morceau a été supprimé."
					data-failure="⚠️ La modification a échoué."
					data-cancel-success="La modification a été annulée."
					data-cancel-failure="⚠️ La modification ne peut être annulée.">
					<fieldset>
						<legend>Supprimer le morceau</legend>
						<input name="name" aria-label="nom du morceau" disabled>
						<button name="save">Supprimer</button>
					</fieldset>
				</form>
				<form class="bottom" method="dialog">
					<button name="share_list">Partager</button><button>Fermer</button>
				</form>
			</div>
		</dialog>
		<dialog id="share">
			<form method="dialog" data-failure="🔗 Lien de partage copié dans le presse-papier.">
				<h2>Partager</h2>
				<label><input type="checkbox" name="current">Morceau en cours</label>
				<label id="legend" title="Tout sélectionner / désélectionner">
					<input type="checkbox" disabled>Morceaux enregistrés
				</label>
				<ul role="group" aria-labelledby="legend"></ul>
				<div class="bottom">
					<button name="share" disabled>Valider</button><button>Annuler</button>
				</div>
			</form>
		</dialog>
		<dialog id="shared">
			<div>
				<h2>Morceaux partagés</h2>
				<ul></ul>
				<form class="bottom" method="dialog" 
					data-success="Tous les morceaux ont été importés."
					data-failure="⚠️ L'import des morceaux a échoué."
					data-cancel-success="L'import des morceaux a été annulé."
					data-cancel-failure="⚠️ L'import des morceaux ne peut être annulé.">
					<button name="import">Importer</button><button>Fermer</button>
				</form>
			</div>
		</dialog>
		<dialog id="about">
			<div>
				<h2>Batucada Sequencer</h2>
				<div>
					<p>Version de l'application : <span id="applicationVersion"></span></p>
					<p>Version des instruments : <span id="instrumentsVersion"></span></p>
					<p>Version des morceaux : <span id="dataDate"></span></p>
					<p>Contact : <a id="contact"></a></p>
				</div>
				<form class="bottom" method="dialog">
					<button>Fermer</button>
				</form>
			</div>
		</dialog>
		<div id="toast" popover="auto"><p></p><button name="cancel">Annuler</button></div>
	</div>
	<script type="module">
		import config       from './config.json' with { type: 'json' };
		import instruments  from './modules/instruments.json' with { type: 'json' };
		import {Interface}  from './modules/interface.js';
		import {Sequencer}  from './modules/sequencer.js';
		import {Presets}    from './modules/presets.js';
		import {UrlState}   from './modules/url_state.js';

		const bus       = new EventTarget();
		const ui        = new Interface(bus, config, instruments);
		const sequencer = new Sequencer(bus, config, instruments);
		const presets   = new Presets(bus, config);
		const urlState  = new UrlState(bus, config, instruments);

		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('sw.js');
		}
	</script>
</body>
</html>